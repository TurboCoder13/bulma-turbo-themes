#!/usr/bin/env sh
set -e
# Run quick CI checks before commit
echo "ðŸ” Running pre-commit CI checks..."

# Add common installation paths to PATH for tools like GitHub Desktop
# which may have restricted PATH
export PATH="$PATH:/usr/local/bin:$HOME/.cargo/bin:$HOME/.local/bin"

# Find uv in PATH or common locations
find_uv() {
  if command -v uv >/dev/null 2>&1; then
    command -v uv
    return 0
  fi
  # Check common installation paths
  for path in /usr/local/bin/uv ~/.cargo/bin/uv ~/.local/bin/uv; do
    if [ -x "$path" ]; then
      echo "$path"
      return 0
    fi
  done
  return 1
}

UV_CMD=$(find_uv)
if [ -z "$UV_CMD" ]; then
  echo "âŒ Error: uv not found. Please install uv: https://github.com/astral-sh/uv"
  echo "   Or ensure uv is in your PATH"
  exit 1
fi

# Run linting and formatting via lintro
"$UV_CMD" run lintro check

# Run theme sync to ensure deterministic generation
bun run theme:sync

# Check for non-deterministic changes in generated files only
GENERATED_PATHS="packages/core/src/themes/packs/catppuccin.synced.ts"
if [ -f "$GENERATED_PATHS" ] && (! git diff --quiet -- "$GENERATED_PATHS" || [ -n "$(git ls-files --others --exclude-standard -- "$GENERATED_PATHS")" ]); then
  echo "âŒ Theme sync generated changes in generated files. Please commit them:"
  git --no-pager diff -- "$GENERATED_PATHS" | cat
  git ls-files --others --exclude-standard -- "$GENERATED_PATHS" || true
  exit 1
fi

# Run TypeScript build
bun run build

# Auto-stage generated files that changed during build
GENERATED_FILES="assets/css/turbo-base.css assets/css/turbo-syntax.css packages/core/src/themes/tokens.json python/src/turbo_themes/tokens.json swift/Sources/TurboThemes/Resources/tokens.json"
for file in $GENERATED_FILES; do
    if [ -f "$file" ] && ! git diff --quiet -- "$file" 2>/dev/null; then
        git add "$file"
        echo "ðŸ“¦ Auto-staged: $file"
    fi
done

# Run tests
bun run test --silent || exit 1

echo "âœ… Pre-commit checks passed!"
