<!doctype html>
<html lang="{{ site.lang | default: 'en' }}" data-theme="auto" data-baseurl="{{ site.baseurl }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="app-i18n"
      data-theme-label="{{ site.data.i18n.en.theme_label }}"
      data-current-theme-title-template="{{ site.data.i18n.en.current_theme_title }}"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests"
    />
    <title>{{ page.title | default: site.title }}</title>
    {% seo %}
    <!-- Blocking script to apply theme immediately from localStorage -->
    <!-- This prevents FOUC by setting theme class before first paint -->
    <script>
      (function () {
        try {
          var STORAGE_KEY = 'bulma-theme-flavor';
          var DEFAULT_THEME = 'catppuccin-mocha';
          // Valid theme IDs - must match THEMES array in theme-selector.js
          var VALID_THEMES = [
            'bulma-light',
            'bulma-dark',
            'catppuccin-latte',
            'catppuccin-frappe',
            'catppuccin-macchiato',
            'catppuccin-mocha',
            'dracula',
            'github-light',
            'github-dark',
          ];
          var savedTheme = localStorage.getItem(STORAGE_KEY) || DEFAULT_THEME;
          // Validate theme ID against allowed list to prevent invalid class/URL injection
          if (VALID_THEMES.indexOf(savedTheme) === -1) {
            savedTheme = DEFAULT_THEME;
          }
          var themeClass = 'theme-' + savedTheme;

          // Apply theme class using classList to preserve existing classes
          // First remove any existing theme classes
          var classList = document.documentElement.classList;
          var classesToRemove = [];
          for (var i = 0; i < classList.length; i++) {
            if (classList[i].indexOf('theme-') === 0) {
              classesToRemove.push(classList[i]);
            }
          }
          classesToRemove.forEach(function (cls) {
            classList.remove(cls);
          });
          // Add the new theme class
          classList.add(themeClass);

          // Preload theme CSS for faster loading
          var baseUrl = document.documentElement.getAttribute('data-baseurl') || '';
          // Sanitize baseUrl to prevent XSS attacks
          function sanitizeUrlPath(path) {
            if (!path) return '';
            // Remove or encode dangerous characters that could be interpreted as HTML/JS
            return path.replace(/[<>"'`&]/g, '').replace(/\\/g, '');
          }
          var sanitizedBaseUrl = sanitizeUrlPath(baseUrl);
          // Resolve path relative to site root
          var base = sanitizedBaseUrl
            ? window.location.origin + sanitizedBaseUrl + '/'
            : window.location.origin + '/';
          var themePath = new URL('assets/css/themes/' + savedTheme + '.css', base).pathname;

          // Create preload link
          var preloadLink = document.createElement('link');
          preloadLink.rel = 'preload';
          preloadLink.as = 'style';
          preloadLink.href = themePath;
          document.head.appendChild(preloadLink);

          // Store theme info for later use
          window.__INITIAL_THEME__ = savedTheme;
        } catch (e) {
          // Silently fail if localStorage is not available
          console.warn('Unable to load saved theme:', e);
        }
      })();
    </script>
    <link rel="icon" href="{{ '/favicon.ico' | relative_url }}" />
    <link
      rel="icon"
      type="image/png"
      href="{{ '/assets/img/bulma-logo.png' | relative_url }}"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ '/assets/img/bulma-logo-dark.png' | relative_url }}"
      media="(prefers-color-scheme: dark)"
    />
    <link
      rel="mask-icon"
      href="{{ '/assets/img/bulma-logo.png' | relative_url }}"
      color="#111827"
    />
    <!-- Critical CSS (above-the-fold) -->
    <style id="theme-critical-css">
      /* Critical CSS inlined for optimal performance */
    </style>
    <!-- Base CSS (shared styles, loaded asynchronously) -->
    <link
      id="theme-base-css"
      rel="preload"
      as="style"
      href="{{ '/assets/css/themes/base.css' | relative_url }}"
      onload="this.rel = 'stylesheet'"
    />
    <noscript>
      <link rel="stylesheet" href="{{ '/assets/css/themes/base.css' | relative_url }}" />
    </noscript>
    <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}" />
    <script type="module" src="{{ '/assets/js/theme-selector.js' | relative_url }}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize navbar highlighting
        if (window.initNavbar) {
          window.initNavbar(document);
        }

        // Initialize burger menu toggle
        const burgers = document.querySelectorAll('.navbar-burger');
        burgers.forEach((burger) => {
          burger.addEventListener('click', () => {
            const targetId = burger.dataset.target;
            const target = document.getElementById(targetId);
            if (target) {
              burger.classList.toggle('is-active');
              target.classList.toggle('is-active');
              // Update aria-expanded
              const isExpanded = burger.classList.contains('is-active');
              burger.setAttribute('aria-expanded', String(isExpanded));
            }
          });
        });
      });
    </script>
  </head>
  <body>
    <nav class="navbar is-spaced" role="navigation" aria-label="main navigation">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="{{ '/' | relative_url }}" data-testid="navbar-brand">
            {{ site.title }}
          </a>
          <button
            class="navbar-burger"
            aria-label="menu"
            aria-expanded="false"
            data-target="navbarBasicExample"
            type="button"
            data-testid="navbar-burger"
            style="min-width: 24px; min-height: 24px"
          >
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </button>
        </div>

        <div id="navbarBasicExample" class="navbar-menu">
          <div class="navbar-start">
            <a class="navbar-item" href="{{ '/' | relative_url }}" data-testid="nav-home">Home</a>
            <a
              class="navbar-item"
              href="{{ '/components/' | relative_url }}"
              data-testid="nav-components"
            >
              Components
            </a>
            <a class="navbar-item" href="{{ '/forms/' | relative_url }}" data-testid="nav-forms"
              >Forms</a
            >
            <div class="navbar-item has-dropdown is-hoverable">
              <button
                class="navbar-link"
                id="nav-reports-trigger"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="nav-reports-menu"
                data-testid="nav-reports"
              >
                Reports
              </button>
              <div
                class="navbar-dropdown"
                id="nav-reports-menu"
                aria-labelledby="nav-reports-trigger"
              >
                <a
                  class="navbar-item"
                  href="{{ '/coverage/' | relative_url }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label="Coverage (opens in new tab)"
                  data-testid="nav-reports-coverage"
                >
                  Coverage
                  <span
                    class="icon is-small"
                    style="margin-left: 0.25rem; display: inline-flex"
                    aria-hidden="true"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                  </span>
                </a>
                <a
                  class="navbar-item"
                  href="{{ '/playwright/' | relative_url }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label="Playwright (opens in new tab)"
                  data-testid="nav-reports-playwright"
                >
                  Playwright
                  <span
                    class="icon is-small"
                    style="margin-left: 0.25rem; display: inline-flex"
                    aria-hidden="true"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                  </span>
                </a>
                <a
                  class="navbar-item"
                  href="{{ '/lighthouse/' | relative_url }}"
                  target="_blank"
                  rel="noopener noreferrer"
                  aria-label="Lighthouse (opens in new tab)"
                  data-testid="nav-reports-lighthouse"
                >
                  Lighthouse
                  <span
                    class="icon is-small"
                    style="margin-left: 0.25rem; display: inline-flex"
                    aria-hidden="true"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                  </span>
                </a>
              </div>
            </div>
          </div>
          <div class="navbar-end">
            <div class="navbar-item has-dropdown is-hoverable" data-testid="theme-dropdown">
              <button
                class="theme-trigger-icon"
                id="theme-flavor-trigger"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="theme-flavor-menu"
                aria-label="Select theme"
                data-testid="theme-trigger"
              >
                <img
                  id="theme-flavor-trigger-icon"
                  src="{{ '/assets/img/catppuccin-logo-macchiato.png' | relative_url }}"
                  alt="Current theme"
                  width="32"
                  height="32"
                />
              </button>
              <div
                class="navbar-dropdown is-right"
                id="theme-flavor-menu"
                aria-labelledby="theme-flavor-trigger"
                data-testid="theme-menu"
                role="menu"
              >
                <!-- Theme items populated by JS -->
              </div>
            </div>
            <div class="select is-rounded is-small is-hidden">
              <select id="theme-flavor-select" aria-label="Theme flavor" disabled></select>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <section class="section">
      <div class="container content" data-testid="main-content">
        <h1 class="title">{{ page.title | default: site.title }}</h1>
        {{ content }}
      </div>
    </section>

    <footer class="footer">
      <div class="content has-text-centered">
        <p><strong>{{ site.title }}</strong> â€” Bulma demo with theme switch.</p>
      </div>
    </footer>
  </body>
</html>
