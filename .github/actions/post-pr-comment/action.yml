---
name: Post PR Comment
description: >-
  Post or update a comment on a pull request with merge-update support

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  marker:
    description: >-
      Unique marker to identify the comment (e.g., "coverage-report")
    required: true
  comment-body:
    description: 'The comment body content'
    required: false
  comment-file:
    description: 'Path to a file whose contents are used as the comment body'
    required: false
  update-mode:
    description: 'Update mode: "replace" or "append"'
    required: false
    default: 'replace'

runs:
  using: composite
  steps:
    - name: Prepare comment body
      id: prepare-body
      shell: bash
      run: |
        if [ -n "${{ inputs.comment-file }}" ]; then
          ./scripts/ci/output-file-content.sh body "${{ inputs.comment-file }}"
        else
          {
            echo "body<<EOF"
            echo "${{ inputs.comment-body }}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        fi

    - name: Find existing comment
      uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4
      id: find-comment
      with:
        token: ${{ inputs.github-token }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: ${{ inputs.marker }}

    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5
      with:
        token: ${{ inputs.github-token }}
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          <!-- ${{ inputs.marker }} -->
          ${{ steps.prepare-body.outputs.body }}
        edit-mode: ${{ inputs.update-mode }}
