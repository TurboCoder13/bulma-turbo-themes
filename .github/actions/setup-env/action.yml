---
name: Setup Environment
description: Set up Bun, Node.js, and Ruby with caching and install dependencies

inputs:
  bun-version:
    description: 'Bun version to use'
    required: false
    default: 'latest'
  node-version:
    description: 'Node.js version to use (for compatibility)'
    required: false
    default: '22'
  ruby-version:
    description: 'Ruby version to use'
    required: false
    default: '3.3.9'
  skip-ruby:
    description: 'Skip Ruby setup (for Node.js-only workflows)'
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
      with:
        bun-version: ${{ inputs.bun-version }}

    - name: Verify Bun installation
      shell: bash
      run: |
        echo "Bun version: $(bun --version)"

    - name: Setup Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
      with:
        node-version: ${{ inputs.node-version }}
        # Note: Bun handles caching, but Node.js is needed for npm publish compatibility

    - name: Verify Node.js version
      shell: bash
      run: ./scripts/ci/verify-node-version.sh "${{ inputs.node-version }}"

    - name: Setup Ruby
      if: inputs.skip-ruby != 'true'
      uses: ruby/setup-ruby@8aeb6ff8030dd539317f8e1769a044873b56ea71 # v1.268.0
      with:
        ruby-version: ${{ inputs.ruby-version }}
        bundler: '2.3.26'
        bundler-cache: true

    - name: Verify Ruby and Bundler setup
      if: inputs.skip-ruby != 'true'
      shell: bash
      run: ./scripts/ci/verify-ruby-setup.sh

    - name: Install Ruby dependencies
      if: inputs.skip-ruby != 'true'
      shell: bash
      run: ./scripts/ci/install-ruby-deps.sh

    - name: Install uv
      uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
      with:
        enable-cache: true

    - name: Install Python via uv
      shell: bash
      run: ./scripts/ci/setup-python-uv.sh

    - name: Install CI dependencies
      shell: bash
      run: ./scripts/ci/install-ci-deps.sh

    - name: Install Node.js dependencies with Bun
      shell: bash
      run: bun install --frozen-lockfile
