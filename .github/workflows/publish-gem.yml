---
name: Publish - Ruby Gem

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.4.0)'
        required: true
        type: string
        default: 'latest'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  actions: write
  id-token: write

concurrency:
  group: publish-gem-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sbom:
    name: ðŸ“‹ Generate & Sign SBOM
    # Uses trust-and-skip pattern: tag already validated in PR workflow
    uses: ./.github/workflows/reusable-sbom.yml
    permissions:
      contents: read
      actions: write
      id-token: write

  build:
    name: ðŸ”¨ Build Gem Package
    needs: [sbom]
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read
    outputs:
      gem-version: ${{ steps.gem-info.outputs.version }}
      gem-name: ${{ steps.gem-info.outputs.name }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            pipelines.actions.githubusercontent.com:443
            registry.npmjs.org:443
            npmjs.org:443
            bun.sh:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: "1.3.6"

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Setup Ruby
        uses: ruby/setup-ruby@675dd7ba1b06c8786a1480d89c384f5620a42647 # v1.281.0
        with:
          ruby-version: '3.3.6'
          bundler-cache: true

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build npm package
        run: bun run build

      - name: Build theme CSS files
        run: bun run build:themes

      - name: Build gem package
        run: bun run build:gem

      - name: Extract gem information
        id: gem-info
        run: ./scripts/ci/extract-gem-info.sh

      - name: Verify gem package
        run: ./scripts/ci/verify-gem-package.sh ${{ steps.gem-info.outputs.path }}

      - name: Run tests against built package
        run: bun run test

      - name: Generate SHA256 checksum
        id: checksum
        run: ./scripts/ci/generate-checksum.sh ${{ steps.gem-info.outputs.path }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: gem-package-${{ steps.gem-info.outputs.version }}
          path: ${{ steps.gem-info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      - name: Build summary
        run: ./scripts/ci/build-summary.sh "${{ steps.gem-info.outputs.name }}" "${{ steps.gem-info.outputs.version }}" "${{ steps.checksum.outputs.sha256 }}"

  publish:
    name: ðŸ“¦ Publish to RubyGems
    needs: [build]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    environment:
      name: rubygems
      url: https://rubygems.org/gems/bulma-turbo-themes
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download gem artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: gem-package-${{ needs.build.outputs.gem-version }}
          path: .

      - name: Verify artifact integrity
        run: ./scripts/ci/verify-artifact.sh

      - name: Setup Ruby
        uses: ruby/setup-ruby@675dd7ba1b06c8786a1480d89c384f5620a42647 # v1.281.0
        with:
          ruby-version: '3.3.6'

      - name: Configure RubyGems credentials
        uses: rubygems/configure-rubygems-credentials@bc6dd217f8a4f919d6835fcfefd470ef821f5c44 # v1.0.0

      - name: Publish to RubyGems
        run: ./scripts/ci/publish-gem.sh

      - name: Summary
        run: ./scripts/ci/publish-summary.sh "${{ needs.build.outputs.gem-version }}" "${{ needs.build.outputs.gem-name }}"
