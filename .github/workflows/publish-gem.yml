---
name: Publish - Ruby Gem

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.4.0)'
        required: true
        type: string
        default: 'latest'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  actions: write
  id-token: write

concurrency:
  group: publish-gem-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sbom:
    name: ðŸ“‹ Generate & Sign SBOM
    # Uses trust-and-skip pattern: tag already validated in PR workflow
    uses: ./.github/workflows/reusable-sbom.yml
    permissions:
      contents: read
      actions: write
      id-token: write

  build:
    name: ðŸ”¨ Build Gem Package
    needs: [sbom]
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read
    outputs:
      gem-version: ${{ steps.gem-info.outputs.version }}
      gem-name: ${{ steps.gem-info.outputs.name }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            pipelines.actions.githubusercontent.com:443
            registry.npmjs.org:443
            npmjs.org:443
            bun.sh:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.1.8"

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '22'

      - name: Setup Ruby
        uses: ruby/setup-ruby@217c988b8c2bf2bacb2d5c78a7e7b18f8c34daed # v1.200.0
        with:
          ruby-version: '3.3.6'
          bundler-cache: true

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build npm package
        run: bun run build

      - name: Build theme CSS files
        run: bun run build:themes

      - name: Build gem package
        run: bun run build:gem

      - name: Extract gem information
        id: gem-info
        run: ./scripts/ci/extract-gem-info.sh

      - name: Verify gem package
        run: ./scripts/ci/verify-gem-package.sh ${{ steps.gem-info.outputs.path }}

      - name: Run tests against built package
        run: bun run test

      - name: Generate SHA256 checksum
        id: checksum
        run: ./scripts/ci/generate-checksum.sh ${{ steps.gem-info.outputs.path }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: gem-package-${{ steps.gem-info.outputs.version }}
          path: ${{ steps.gem-info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      - name: Build summary
        run: ./scripts/ci/build-summary.sh "${{ steps.gem-info.outputs.name }}" "${{ steps.gem-info.outputs.version }}" "${{ steps.checksum.outputs.sha256 }}"

  publish:
    name: ðŸ“¦ Publish to RubyGems
    needs: [build]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    environment:
      name: rubygems
      url: https://rubygems.org/gems/bulma-turbo-themes
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Download gem artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: gem-package-${{ needs.build.outputs.gem-version }}
          path: .

      - name: Verify artifact integrity
        run: ./scripts/ci/verify-artifact.sh

      - name: Setup Ruby
        uses: ruby/setup-ruby@217c988b8c2bf2bacb2d5c78a7e7b18f8c34daed # v1.200.0
        with:
          ruby-version: '3.3.6'

      - name: Configure RubyGems credentials
        uses: rubygems/configure-rubygems-credentials@bc6dd217f8a4f919d6835fcfefd470ef821f5c44 # v1.0.0

      - name: Publish to RubyGems
        run: ./scripts/ci/publish-gem.sh

      - name: Summary
        run: ./scripts/ci/publish-summary.sh "${{ needs.build.outputs.gem-version }}" "${{ needs.build.outputs.gem-name }}"
