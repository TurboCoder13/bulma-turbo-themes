---
name: Reporting - External Link Validation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # 2 AM UTC daily (nightly)

permissions:
  contents: read
  issues: write

concurrency:
  group: link-monitoring
  cancel-in-progress: false

jobs:
  validate-external-links:
    name: ðŸ”— Check External Links
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        if: ${{ !env.ACT }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          node-version: '22'
          skip-ruby: 'true'

      - name: Build Astro site
        run: bun run build:ci:site

      - name: Validate external links
        id: link-check
        run:
          ./scripts/ci/run-htmlproofer.sh --site-dir apps/site/dist --output
          link-check-output.txt

      - name: Parse link check results
        id: results
        run: ./scripts/ci/parse-link-check-results.sh

      - name: Create issue on external link failures
        if: steps.results.outputs.status == 'warning'
        uses: actions/github-script@450193c5abd4cdb17ba9f3ffcfe8f635c4bb6c2a
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('link-check-output.txt', 'utf8');

            // Check if there are actual failures (not just warnings)
            if (output.includes('HTML-Proofer found')) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— External Link Issues Detected',
                body: [
                  '## External Link Validation Report',
                  '```',
                  output,
                  '```',
                  '',
                  '**Note:** External link failures are non-blocking and may be transient.',
                  'Please review and investigate persistent failures.',
                ].join('\\n'),
                labels: ['type:monitoring', 'priority:low'],
              });
            }

      - name: Upload link validation report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: link-validation-report
          path: link-check-output.txt
          retention-days: 30
