name: Reporting - External Link Validation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *" # 2 AM UTC daily (nightly)

permissions:
  contents: read
  issues: write

concurrency:
  group: link-monitoring
  cancel-in-progress: false

jobs:
  validate-external-links:
    name: ðŸ”— Check External Links
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493

      - name: Setup Ruby
        uses: ruby/setup-ruby@d5126b9b3579e429dd52e51e68624dda2e05be25
        with:
          ruby-version: "3.4.7"
          bundler-cache: true

      - name: Build Jekyll site
        run: bundle exec jekyll build --trace --strict_front_matter

      - name: Validate external links
        id: link-check
        run: |
          bundle exec htmlproofer \
            --assume-extension \
            --allow-hash-href \
            --allow-missing-href \
            --no-enforce-https \
            --typhoeus '{"timeout": 30, "max_redirects": 5, "retry": {"max_retries": 2}}' \
            --report-missing-doctype false \
            --report-sce false \
            ./_site 2>&1 | tee link-check-output.txt || true

      - name: Parse link check results
        id: results
        run: |
          if grep -q "HTML-Proofer finished successfully" link-check-output.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "External links validated successfully"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "Some external links may have issues (see full log)"
          fi

      - name: Create issue on external link failures
        if: steps.results.outputs.status == 'warning'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('link-check-output.txt', 'utf8');

            // Check if there are actual failures (not just warnings)
            if (output.includes('HTML-Proofer found')) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— External Link Issues Detected',
                body: `## External Link Validation Report\n\n\`\`\`\n${output}\n\`\`\`\n\n**Note:** External link failures are non-blocking and may be transient.\nPlease review and investigate persistent failures.`,
                labels: ['type:monitoring', 'priority:low']
              });
            }

      - name: Upload link validation report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: link-validation-report
          path: link-check-output.txt
          retention-days: 30
