---
name: Reusable - SBOM Generation
# Reusable workflow for Software Bill of Materials generation.
# Creates SBOM in multiple formats (CycloneDX, SPDX) and uploads as artifacts for supply chain security.

on:
  workflow_call:

permissions:
  contents: read
  actions: write
  id-token: write # Required for cosign signing

jobs:
  sbom:
    name: ðŸ“‹ Generate SBOM (Multi-format)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            uploads.github.com:443
            pipelines.actions.githubusercontent.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            raw.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            registry.npmjs.org:443
            npmjs.org:443
            cdn.jsdelivr.net:443
            anchore.io:443
            get.anchore.io:443
            toolbox-data.anchore.io:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443
            timestamp.sigstore.dev:443
            sigstore-tuf-root.storage.googleapis.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Syft
        run: ./scripts/ci/install-syft.sh

      - name: Create SBOM directory
        run: mkdir -p sbom

      - name: Generate SBOM (CycloneDX JSON)
        run: syft dir:. -o cyclonedx-json > sbom/sbom.cyclonedx.json

      - name: Generate SBOM (SPDX JSON)
        run: syft dir:. -o spdx-json > sbom/sbom.spdx.json

      - name: Generate SBOM (CycloneDX XML)
        run: syft dir:. -o cyclonedx-xml > sbom/sbom.cyclonedx.xml

      - name: Validate CycloneDX SBOM
        run: ./scripts/ci/validate-sbom.sh cyclonedx

      - name: Validate SPDX SBOM
        run: ./scripts/ci/validate-sbom.sh spdx

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign SBOM files with Cosign
        run: ./scripts/ci/sign-sbom.sh

      - name: Verify SBOM signatures
        run: ./scripts/ci/verify-sbom-signatures.sh

      - name: Upload SBOM artifacts (all formats with signatures)
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom-all-formats
          path: sbom/
          overwrite: true
          retention-days: 90
