---
name: Reusable - SBOM Generation
# Reusable workflow for Software Bill of Materials generation.
# Creates SBOM in multiple formats (CycloneDX, SPDX) and uploads as artifacts for supply chain security.

on:
  workflow_call:

permissions:
  contents: read
  actions: write
  id-token: write # Required for cosign signing

jobs:
  sbom:
    name: ðŸ“‹ Generate SBOM (Multi-format)
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@92c522aaa6f53af082553dedc1596c80b71aba33
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            uploads.github.com:443
            pipelines.actions.githubusercontent.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            raw.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            anchore.io:443
            get.anchore.io:443
            toolbox-data.anchore.io:443
            fulcio.sigstore.dev:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install Syft
        run: ./scripts/ci/install-syft.sh

      - name: Create SBOM directory
        run: mkdir -p sbom

      - name: Generate SBOM (CycloneDX JSON)
        run: syft dir:. -o cyclonedx-json > sbom/sbom.cyclonedx.json

      - name: Generate SBOM (SPDX JSON)
        run: syft dir:. -o spdx-json > sbom/sbom.spdx.json

      - name: Generate SBOM (CycloneDX XML)
        run: syft dir:. -o cyclonedx-xml > sbom/sbom.cyclonedx.xml

      - name: Validate CycloneDX SBOM
        run: ./scripts/ci/validate-sbom.sh cyclonedx

      - name: Validate SPDX SBOM
        run: ./scripts/ci/validate-sbom.sh spdx

      - name: Install Cosign
        uses: sigstore/cosign-installer@7e8b541eb2e61bf99390e1afd4be13a184e9ebc5 # v3.10.1

      - name: Sign SBOM files with Cosign
        run: ./scripts/ci/sign-sbom.sh

      - name: Verify SBOM signatures
        run: ./scripts/ci/verify-sbom-signatures.sh

      - name: Upload SBOM artifacts (all formats with signatures)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom-all-formats
          path: sbom/
          overwrite: true
          retention-days: 90
