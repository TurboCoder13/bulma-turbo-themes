name: Reporting - Lighthouse CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  actions: write
  pull-requests: write

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lhci:
    name: 📊 Lighthouse Performance Analysis
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - name: Harden Runner
        if: ${{ !env.ACT }}
        uses: step-security/harden-runner@c6295a65d1254861815972266d5933fd6e532bdf
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            uploads.github.com:443
            pipelines.actions.githubusercontent.com:443
            results-receiver.actions.githubusercontent.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
            registry.npmjs.org:443
            npmjs.org:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            cdn.jsdelivr.net:443
            bulma.io:443
            www.google.com:443
            android.clients.google.com:443
            chrome-devtools-frontend.appspot.com:443
            devtools.remote:443
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          node-version: "22"
          ruby-version: "3.3"

      - name: Run full CI pipeline with Lighthouse
        run: |
          ./scripts/local/build.sh --full

      - name: Verify Lighthouse results
        run: |
          if [ ! -d ".lighthouse" ] || [ -z "$(ls -A .lighthouse 2>/dev/null)" ]; then
            echo "❌ Lighthouse CI failed - no results generated"
            echo "This indicates Lighthouse could not run properly"
            echo "Check the build logs above for network or other errors"
            exit 1
          else
            echo "✅ Lighthouse CI completed successfully"
            echo "Results found in .lighthouse directory:"
            ls -la .lighthouse/
          fi

      - name: Generate Lighthouse PR comment
        if: github.event_name == 'pull_request' && always()
        run: |
          echo "## 📊 Lighthouse CI Report" > lighthouse-comment.md
          echo "" >> lighthouse-comment.md
          echo "Lighthouse performance analysis completed." >> lighthouse-comment.md
          echo "" >> lighthouse-comment.md

          # Check if lighthouse results exist
          if [ -d ".lighthouse" ] && [ -n "$(ls -A .lighthouse 2>/dev/null)" ]; then
            echo "### Results" >> lighthouse-comment.md
            echo "" >> lighthouse-comment.md
            echo "✅ Lighthouse CI analysis completed successfully." >> lighthouse-comment.md
            echo "" >> lighthouse-comment.md
            echo "Check the artifacts for detailed reports." >> lighthouse-comment.md
          else
            echo "⚠️ No Lighthouse results found. Check workflow logs for details." >> lighthouse-comment.md
          fi

          echo "" >> lighthouse-comment.md
          echo "---" >> lighthouse-comment.md
          echo "*Generated by Lighthouse CI on commit ${{ github.sha }}*" >> lighthouse-comment.md

      - name: Post Lighthouse comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: ./.github/actions/post-pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-file: lighthouse-comment.md
          marker: lighthouse-ci-comment

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: lighthouse-reports
          path: .lighthouse
          if-no-files-found: warn
          overwrite: true
